// enable-archery.c
// by airke
// By Swy ×îºóĞŞÕı QC 98/6/23
#include <combat.h>
#include <ansi.h>
inherit SKILL;

void god_att(object me, object victim, object  weapon, int damage);
void shooting_att(object me,object victim, object weapon,int damage);
void sp_attack1(object me, object victim, object  weapon, int damage);
void sp_attack2(object me, object victim, object  weapon, int damage);
void sp_attack3(object me, object victim, object  weapon, int damage);
int cps=this_player()->query("cps",1);
int sp_value;

string *lan_yan = ({
"$NÊ¹³öÁ÷ĞÇ¼ı·¨µÚÒ»Ê½¡®Ò»Ğ¹Ç§Àï¡¯£¬Éä³öµÄ$w»¯³ÉÒ»µÀĞÇÃ¢£¬Ğ®×ÅÕóÕóÉ³ÀË£¬Ò»Ê±¼äÑÌ³¾ËÄÆğ\n",

"$NÊ¹³öÁ÷ĞÇ¼ı·¨µÚ¶şÊ½¡®Ë«Áú³öº£¡¯£¬Éä³öµÄ$w»¯³ÉÁ½µÀĞÇÃ¢£¬Ò»×óÒ»ÓÒ£¬ÈçË«ÁúÇÀÖé°ã\n",

"$NÊ¹³öÁ÷ĞÇ¼ı·¨µÚÈıÊ½¡®Èı·Ö¶¦×ã¡¯£¬Éä³öµÄ$w»¯³ÉÈıµÀĞÇÃ¢£¬ÈçÈı¹ú¶¦Á¢°ã£¬³¯Í· ¸¹ ¼°ºíÁü¼²Éä¶øÈ¥\n",

"$NÊ¹³öÁ÷ĞÇ¼ı·¨µÚËÄÊ½¡®ËÄÃæ³ş¸è¡¯£¬Éä³öµÄ$w»¯³ÉËÄµÀĞÇÃ¢£¬ËÆÓĞÁéĞÔ£¬³¯ÊÖ×ãËÄ´¦¹Ø½Ú¼²Éä¹ıÈ¥\n",

"$NÊ¹³öÁ÷ĞÇ¼ı·¨µÚÎåÊ½¡®ÎåÂí·ÖÊ¬¡¯£¬Éä³öµÄ$w»¯³ÉÎåµÀĞÇÃ¢£¬ËÆÓĞÁéĞÔ£¬³¯Í·¼°ËÄÖ«¼²Éä¶øÈ¥\n",

"$NÊ¹³öÁ÷ĞÇ¼ı·¨µÚÁùÊ½¡®ÁùµÀÂÖ»Ø¡¯£¬Éä³öµÄ$w»¯³ÉÁùµÀĞÇÃ¢£¬ÁùµÀĞÇÃ¢²»¶ÏµÄĞı×ª×Å³¯Ç°¼²ËÙ·ÉÈ¥\n",

"$NÊ¹³öÁ÷ĞÇ¼ı·¨µÚÆßÊ½¡®ÆßĞÇÁ¬Ïß¡¯£¬Éä³öµÄ$w»¯³ÉÆßµÀĞÇÃ¢£¬ÆßµÀĞÇÃ¢ÅÅ³ÉÒ»Ïß¼²·É¶øÈ¥\n",

"$NÊ¹³öÁ÷ĞÇ¼ı·¨µÚ°ËÊ½¡®°ËÏÉ¹ıº£¡¯£¬Éä³öµÄ$w»¯³É°ËµÀĞÇÃ¢£¬°ËµÀĞÇÃ¢È¥ÊÆºö×óºöÓÒ£¬çÎç¿²»¶¨\n",

"$NÊ¹³öÁ÷ĞÇ¼ı·¨µÚ¾ÅÊ½¡®¾Å¾Å¹éÔª¡¯£¬Éä³öµÄ$w»¯³É¾ÅµÀĞÇÃ¢£¬¾ÅµÀĞÇÃ¢ÓÖºÏ¶øÎªÒ»£¬È¥ÊÆÊ®·ÖĞ×ÃÍ\n",
});

// ÓĞ¼ıÊ±µÄĞğÊö $wÊÇ¹­ $c ÊÇ¼ı
//Ó¦Íæ¼ÒÒªÇó.Ôö¼ÓÁ¬»÷ by poloer
mapping *arrow_action = ({
//1
        ([      "action":
"$N¿´¼û$nÕĞÊÆÒÑ¾¡£¬Ñ¸ËÙ½«$c´îÓÚ$wÖ®ÉÏ£¬Ê¹³öÁ÷ĞÇ¼ı·¨µÚÒ»Ê½¡¸Ò»Ğ¹Ç§Àï¡±£¬¼ıÊÆÈçºéË®¿ñĞ¹°ã³¯$n$l·ÉÉä¶øÈ¥[m",
                "dodge":        -100,
                "damage":       130,
                "parry":        -100,
                "force":        130,
                "damage_type": "ÉäÉË",
        ]),
//2
([        "action":
"$N½«ÊÖÉÏ$cÑ¸ËÙ´îÓÚ$w·ÖÎªÁ½´ÎÉä³ö£¬Ê¹³öÁ÷ĞÇ¼ı·¨µÚ¶şÊ½"HIG"¡¸Ë«Áú³öº£¡±"NOR"£¬·ÖÉä³öÖ®$cÈçË«Áú¿ñÊÉ°ã³¯$n¶øÈ¥",
                "dodge":        -100,
                "damage":       130,
                "force" :       130,
                "damage_type": "ÉäÉË",
                "parry":        -100,
        ]),
//3
        ([      "action":
"$N°ÔÆøÍ»ÕÇ£¬½«ÊÖÖĞ$cÑ¸ËÙ´îÓÚ$wÈı¼ıÆë·¢£¬Ê¹³öÁ÷ĞÇ¼ı·¨µÚÈıÊ½"HIB"¡¸Èı·Ö¶¦×ã¡±"NOR"£¬Éä³öµÄ$cËÆº¬Èı¹ú¶¦Á¢Ö®°ÔÆø·ÖÈı´¦Ïò$n¼±Éä¶øÈ¥",
                "dodge":        -100,
                "damage":       130,
                "force":         130,
                "parry":        -100,
                "damage_type": "ÉäÉË",
        ]),
//4
        ([      "action":
"$N±»$n¹¥ÊÆËù¾ªÏÅ£¬½«ÊÖÖĞ$cÑ¸ËÙ´îÓÚ$wÖ®ÉÏ·ÖÉäËÄ¼ı£¬Ê¹³öÁ÷ĞÇ¼ı·¨µÚËÄÊ½"HIY"¡¸ËÄÃæ³ş¸è¡±"NOR"£¬Éä³öµÄ$cËÆÓĞÁéĞÔ°ãÓÉ$nÇ°ºó×óÓÒËÄÃæ·ÉÉä¶øÈ¥",
                "dodge":        -100,
                "damage":       130,
                "force":        130,
                "parry":        -100,
                "damage_type": "ÉäÉË",
        ]),
//5
        ([      "action":
"$NĞÄÖĞÉ±ÆøÍ»ÕÇ£¬½«ÊÖÖĞ$cÑ¸ËÙ´îÓÚ$wÉÏÎå¼ıÆëÉä£¬É±ÆøÈÚºÏÓÚ$cÊ¹³öÁ÷ĞÇ¼ı·¨µÚÎåÊ½"HIW"¡¸ÎåÂí·ÖÊ¬¡±"NOR"£¬$c³¯$nÍ·¼°Ë«ÊÖË«½ÅÆëÉä¶øÈ¥",
                "dodge":        -100,
                "damage":       110,
                "force":        130,
                "parry":        -100,
                "damage_type": "ÉäÉË",
        ]),
//6
        ([      "action":
"$N½«ÊÖÖĞ$cÑ¸ËÙ´îÓÚ$w£¬Éä³öÖ®¼ÊÈÚÈëĞı×ªÆø¾¢Ê¹³öÁ÷ĞÇ¼ı·¨µÚÁùÊ½"HIG"¡¸ÁùµÀÂÖ»Ø¡±"NOR"£¬$c¼±ËÙĞı×ª³¯×Å$n¼±Éä¶øÈ¥",
                "dodge":        -100,
                "damage":       115,
                "foece":        130,
                "parry":        -100,
                "damage_type": "ÉäÉË",
        ]),
//7
        ([      "action":
"$N½«ÊÖÖĞ$cÑ¸ËÙ´îÓÚ$wÁ¬ĞøÉä³öÆß¼ı£¬Ê¹³öÁ÷ĞÇ¼ı·¨µÚÆßÊ½"HIM"¡¸ÆßĞÇÁ¬Ïß¡±"NOR"£¬$cÆß¼ıÒ»¼ı½Ó×ÅÒ»¼ıĞÎ³ÉÒ»Ïß³¯$n¼±Éä¶øÈ¥",
                "dodge":        -100,
                "damage":       130,
                "force":        130,
                "parry":        -100,
                "damage_type": "ÉäÉË",
        ]),
//8
        ([      "action":
"$N½«ÊÖÖĞ$cÑ¸ËÙ´îÓÚ$w»º»ºÉä³ö£¬Ê¹³öÁ÷ĞÇ¼ı·¨µÚ°ËÊ½"HIC"¡¸°ËÏÉ¹ıº£¡±"NOR"£¬$cÈçÍ¬ÏÉÈË¹ıº£°ãçÎç¿°ãÁî$n²»ÖªËù´ë",
                "dodge":        -100,
                "damage":       130,
                "force":        130,
                "parry":        -100,
                "damage_type": "ÉäÉË",
                "post_action":  (: god_att :),
        ]),
//9
        ([      "action":
"$N½«ÊÖÖĞ$cÑ¸ËÙ´îÓÚ$w»º»ºÉä³ö¾Å¼ı£¬Ê¹³öÁ÷ĞÇ¼ı·¨µÚ¾ÅÊ½"HIR"¡¸¾Å¾Å¹éÔª¡±"NOR"£¬Éä³ö¾Å¼ıºÏÒ»£¬Áî$nÎŞ·¨ÕĞ¼Ü",
                "dodge":        -100,
                "damage":       130,
                "parry":        -100,
                "force":        130,
                "damage_type": "ÉäÉË",
                "post_action":  (: shooting_att :),
        ]),
//10
        ([      "action":
"        $NÁìÎòµ½Á÷ĞÇ¼ı·¨Ö®¸÷Ê½°ÂÃî£¬½«¾ÅÊ½¼ı·¨Á¬ĞøÊ¹³ö£¬»¯ÎªÒ»Ê½\n"
"            ¡®¡«¡«¡«¡«·ï¡«¡«¡«Îè¡«¡«¡«¾Å¡«¡«¡«Ìì¡«¡«¡«¡«¡¯      \n"
"        ¾ÅÊ½¼ı·¨¿´ËÆÍ¬Ê±Éä³ö°ã£¬$c»¯ÎªÎŞÊıÁ÷ĞÇ³¯×Å$n$l¸÷´¦ÉäÈ¥",
                "dodge":        -100,
                "damage":       130,
                "parry":        -100,
                "force":        130,
                "damage_type": "ÉäÉË",
                "post_action":  (: sp_attack1 :),
        ]),
//11
        ([      "action":
"        $N½«±ùĞÄ¾÷Ö®ÄÚ¾¢°µÔËÓÚ$cÉÏ£¬½«ÊÖÖĞ$c´îÓÚ$wÉä³ö£¬»¯ÎªÒ»Ê½\n "
"            ¡®¡«¡«¡«¡«Ê®¡«¡«¡«Íò¡«¡«¡«»ğ¡«¡«¡«¼±¡«¡«¡«¡«¡¯      \n"
"        ¼ıÊÆ¿´ËÆÈáÈõÎŞÁ¦£¬$cÈ¥ÊÆçÎç¿²»¶¨µÄ³¯×Å$nÉíÌå¼²ËÙ·ÉÈ¥¡£    ",
                "dodge":        -100,
                "damage":       130,
                "parry":        -100,
                "force":        130,
                "damage_type": "ÉäÉË",
                "post_action":  (: sp_attack2 :),
        ]),
});

// ÏÂÃæÊÇÃ»¼ıÊ±µÄ¹¥»÷ĞğÊö

mapping *bow_action = ({
        ([      "action":               "$N¾ÙÆğ$wºİºİµØÍù$n$lÔÒÈ¥",
                "dodge":        -10,
                "damage":       10,
                "parry":        -10,
                "damage_type":  "ğöÉË",

        ]),
        ([      "action":               "$N³ÔÁ¦µØ»ÓÎè$wÊÔ×Å´òÉË$n",
                "dodge":        -5,
                "damage":       15,
                "parry":        -10,
                "damage_type":    "ğöÉË",

        ]),
});

int valid_learn(object me)
{
        object ob;

if(me->query_skill("archery",1)<15)
                return notify_fail("ÒªÁ·Á÷ĞÇ¼ı·¨ÒªÏÈÓĞÏàµ±µÄ¹­¼ı»ù´¡¡£\n");

        if( !(ob = me->query_temp("weapon"))
        ||      (string)ob->query("skill_type")!="archery")
                return notify_fail("ÄãÊÖÉÏÒªÓĞ¹­¼ı²ÅÄÜÁ·Á÷ĞÇ¼ı·¨¡£\n");

        return 1;
}

int valid_enable(string usage)
{
        return usage=="archery" || usage=="parry";
}


mapping query_action(object me, object weapon)
{
  int skill_level, limit;
  object wpn = me->query_temp("weapon");
  int i;
//ÒÔÏÂ¼¸ĞĞ¶¼ÊÇ±ØĞëµÄ..
//-----------------------------------------------------
//
// i = Ä¿Ç°¹­ÉÏµÄ¼ıÊı
  i=wpn->query("arrow/amount");
if ( !userp(me) )
        i ++;

//Õ½¶·ÖĞÉäÍêÒ²±ØĞë½«¹­³õÊ¼»¯
// 1µÄÊ±ºò¾Í¿ÉÒÔ³õÊ¼»¯....ÒòÎª³õÊ¼»¯Íê»¹»á¹¥»÷Ò»´Î

 if(i==1) {
        tell_object(me, "\nÄãµÄ" + wpn->query("arrow/name") + "ÓÃÍêÁË£¡\n\n");
        wpn->set("arrow/id","none");
        wpn->set("arrow/name","¿ÕµÄ");
        wpn->set("weapon_prop/damage",wpn->query("bow/attack"));

  }
  if (i > 0) {
        i--;
        wpn->set("arrow/amount",i);
                // ºô½ĞÓĞ¼ıÊ±µÄĞğÊö
        return arrow_action[random(sizeof(arrow_action))];
  }

  if( i <= 0) {
                //ºô½ĞÃ»¼ıµÄ¹¥»÷ĞğÊö
        return bow_action[random(sizeof(bow_action))];
  }
//----- under by poloer from --------------------------------------------


        skill_level=(int)me->query_skill("god-shooting", 1);

       if (skill_level < 10)
                return arrow_action[random(2)];
        else if (skill_level < 20 )
                return arrow_action[random(3)];
        else if (skill_level < 30 )
               return arrow_action[random(4)];
                else if (skill_level < 50 )
                return arrow_action[random(5)];
               else if (skill_level < 70 )
                       return arrow_action[random(6)];
               else if (skill_level < 80 )
                      return arrow_action[random(6)+1];
        else if(skill_level<90)
return arrow_action[random(6)+2];
        else
return arrow_action[random(6)+3];


}

int practice_skill(object me)
{
        if( (int)me->query("kee") < 30
        ||      (int)me->query("force") < 3 )
                return notify_fail("ÄãµÄÄÚÁ¦»òÆø²»¹»£¬²»ÄÜÁ·Á÷ĞÇ¼ı·¨¡£\n");
        me->receive_damage("kee", 30);
        me->add("force", -3);
        return 1;
}

string perform_action_file(string action)
{
        return CLASS_D("marksman")+"/god-shooting/"+action;
}

void god_att(object me, object victim, object  weapon, int damage)
{
if((random(80)<me->query_skill("iceforce",1))&&!me->set_temp("break"))
{
victim->start_busy(1);
message_vision(HIB"$N°µÊ¹±ùĞÄ¾÷Ö®Òõº®ÄÚ¾¢£¬½«$nÊÜÄÚ¾¢ËùÀ§¶¯µ¯²»µÃ¡£\n"NOR, me, victim);

}
}

void shooting_att(object me, object victim, object  weapon, int damage)
{
        int lose, i;
int bellpower = (int)me->query("cps")/3;
        // modify by oda
        // combat_exp Ö®±È½ÏÔÚ×ÔÉíÖ® exp ¼ÓÉÏ random
        // lose = skill/10 + 1 ¸ÄÎª random(skill/10) + 3
        // Ôö¼ÓÁ¬»÷Íê±Ï busy Ò»»ØºÏ
if(random(100)<70)
        {
        if(bellpower > 5) bellpower=5;
        lose=random(10);
                me->set_temp("berserk", 1);
                for(i = 0;i < lose; i++)
                {
       message_vision(HIR"$NÄÃÆğÊıÖ§¼ıÊ¹¾¢µÄÍù$nÁ¬Éä¹ıÈ¥¡£\n"NOR, me,victim);
                       }
                victim->add("kee",-50);
                me->delete_temp("berserk");
                message_vision(HIW"Ò»Õó»ìÂÒºó£¬$NÓÃ¾¢¹ı¶È£¬¸Ï½ô³Ã»úµ÷Ï¢¡£\n"NOR,me);

        }
}

void sp_attack1(object me, object victim, object  weapon, int damage)
{
  string do_action;
  string arg;
  mixed all;
  object *enemy,who,room,weaponn,obj;
  string actionn;
  int i,j,force;

  force=me->query("force",1);
  enemy = me->query_enemy();
  i=random(sizeof(enemy));

//³öÏÖÂÊ 1/2*1/7=~7%
if( me->query("family/family_name")=="ÉäÈÕÅÉ"){
message_vision(HIY"
giggle
\n"NOR,me,victim);

  if( me->query("max_force") > 1000) {
    for(j=0; j < 9; j++) {
       do_action = lan_yan[j];
       actionn = "\n";
       actionn += do_action;

       if( weaponn=me->query_temp("weapon") )
       actionn = replace_string(actionn, "$w", weaponn->name());
       message_vision(actionn, me, enemy[i]);
          if( random(me->query("combat_exp")) >
        random(enemy[i]->query("combat_exp"))/6 ) {
        message_vision("\nµ«ÊÇ$NÉÁ¶ã²»¼°£¬ÉíÉÏ²åÁËÒ»Ö»Ö»µÄÀû¼ı¡£\n" ,enemy[i]);
        enemy[i]->receive_damage("kee",50,me);
        me->add("force",-30);
        COMBAT_D->report_status(enemy[i]);
                                                  }
   else message_vision("\n$N¿´×¼¼ıµÄÀ´ÊÆ£¬²»»Å²»Ã¦µÄÇáÒ×ÉÁ±Ü¡£\n" ,enemy[i]);
     if( random(me->query("cps")) < 10 && random(me->query("combat_exp",1)) < 1000000) {
        me->add("force",-100);

message_vision("\n$NÊ¹³ö"HIR"¡®¡«¡«¡«¡«·ç¡«¡«¡«Îè¡«¡«¡«¾Å¡«¡«¡«Ìì¡«¡«¡«¡«¡¯"NOR"ºó£¬ÓÉÓÚ¶¨Á¦»ò¾­Ñé²»×ã£¬ÌåÄÚÕæÆøÒ»Ê±ÎŞÒÔÎª¼Ì\n",me);
        me->start_busy(1);
                                        }
                                                  }
                                             }

}
}
